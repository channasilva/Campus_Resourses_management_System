<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard Functions</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #374151;
        }
        button {
            padding: 10px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #2563eb;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .result.success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .result.error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .result.info {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        .result.warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .instructions {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        .status.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status.warning {
            background-color: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Dashboard Functions</h1>
        
        <div class="instructions">
            <h3>üìã What This Tool Does:</h3>
            <p>This tool tests each dashboard function individually to identify which ones are working and which ones are failing. It will help us pinpoint exactly what's causing the dashboard issues.</p>
        </div>
        
        <div class="test-section">
            <h3>üîê Authentication Test <span id="auth-status" class="status"></span></h3>
            <button onclick="testAuthentication()">Test Authentication</button>
            <div id="auth-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üë• Users Test <span id="users-status" class="status"></span></h3>
            <button onclick="testGetAllUsers()">Test Get All Users</button>
            <div id="users-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üìö Resources Test <span id="resources-status" class="status"></span></h3>
            <button onclick="testGetResources()">Test Get Resources</button>
            <div id="resources-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üìã Bookings Test <span id="bookings-status" class="status"></span></h3>
            <button onclick="testGetAllBookings()">Test Get All Bookings</button>
            <button onclick="testGetBookingsByUser()">Test Get User Bookings</button>
            <div id="bookings-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üîî Notifications Test <span id="notifications-status" class="status"></span></h3>
            <button onclick="testGetAllNotifications()">Test Get All Notifications</button>
            <button onclick="testGetNotificationsByUser()">Test Get User Notifications</button>
            <div id="notifications-result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üéØ Complete Dashboard Test <span id="dashboard-status" class="status"></span></h3>
            <button onclick="testCompleteDashboard()">Test Complete Dashboard Loading</button>
            <div id="dashboard-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, getDocs, collection, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDa63IAknYHAx_zUbxtCXXaxYnh8ExZ9fY",
            authDomain: "campus-resources-demo.firebaseapp.com",
            projectId: "campus-resources-demo",
            storageBucket: "campus-resources-demo.firebasestorage.app",
            messagingSenderId: "96808245065",
            appId: "1:96808245065:web:75462c690a22b3e887ec98"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // Wait for auth state to be determined
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-status').textContent = 'Authenticated';
                document.getElementById('auth-status').className = 'status success';
            } else {
                document.getElementById('auth-status').textContent = 'Not Authenticated';
                document.getElementById('auth-status').className = 'status error';
            }
        });

        function showResult(elementId, content, type = 'info') {
            const resultDiv = document.getElementById(elementId);
            resultDiv.style.display = 'block';
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = content;
        }

        function updateStatus(elementId, status, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = status;
            statusElement.className = `status ${type}`;
        }

        window.testAuthentication = async () => {
            showResult('auth-result', 'Testing authentication...\n\n', 'info');
            
            let result = 'üîê Authentication Test\n';
            result += '====================\n\n';
            
            try {
                result += `Current User: ${currentUser ? 'Authenticated' : 'Not Authenticated'}\n`;
                
                if (currentUser) {
                    result += `User ID: ${currentUser.uid}\n`;
                    result += `Email: ${currentUser.email}\n`;
                    result += `Display Name: ${currentUser.displayName || 'None'}\n`;
                    result += `Email Verified: ${currentUser.emailVerified}\n`;
                    result += `Creation Time: ${new Date(currentUser.metadata.creationTime).toLocaleString()}\n`;
                    result += `Last Sign In: ${new Date(currentUser.metadata.lastSignInTime).toLocaleString()}\n\n`;
                    
                    // Test getting user document from Firestore
                    try {
                        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            result += `‚úÖ User document found in Firestore\n`;
                            result += `Role: ${userData.role || 'Not set'}\n`;
                            result += `Username: ${userData.username || 'Not set'}\n`;
                            result += `Department: ${userData.department || 'Not set'}\n`;
                        } else {
                            result += `‚ùå User document not found in Firestore\n`;
                        }
                    } catch (error) {
                        result += `‚ùå Error getting user document: ${error.message}\n`;
                    }
                    
                    updateStatus('auth-status', 'Success', 'success');
                    showResult('auth-result', result, 'success');
                } else {
                    result += '‚ùå No authenticated user found\n';
                    result += 'This explains why dashboard functions are failing\n';
                    updateStatus('auth-status', 'Failed', 'error');
                    showResult('auth-result', result, 'error');
                }
            } catch (error) {
                result += `‚ùå Authentication test failed: ${error.message}\n`;
                updateStatus('auth-status', 'Error', 'error');
                showResult('auth-result', result, 'error');
            }
        };

        window.testGetAllUsers = async () => {
            showResult('users-result', 'Testing get all users...\n\n', 'info');
            
            let result = 'üë• Users Test\n';
            result += '=============\n\n';
            
            try {
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                const users = usersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                result += `‚úÖ Successfully fetched ${users.length} users\n\n`;
                
                if (users.length > 0) {
                    result += 'User Details:\n';
                    users.forEach((user, index) => {
                        result += `${index + 1}. ${user.username || user.email || 'Unknown'} (${user.role || 'No role'})\n`;
                    });
                } else {
                    result += 'No users found in database\n';
                }
                
                updateStatus('users-status', 'Success', 'success');
                showResult('users-result', result, 'success');
            } catch (error) {
                result += `‚ùå Error fetching users: ${error.message}\n`;
                updateStatus('users-status', 'Failed', 'error');
                showResult('users-result', result, 'error');
            }
        };

        window.testGetResources = async () => {
            showResult('resources-result', 'Testing get resources...\n\n', 'info');
            
            let result = 'üìö Resources Test\n';
            result += '================\n\n';
            
            try {
                const resourcesRef = collection(db, 'resources');
                const snapshot = await getDocs(resourcesRef);
                
                if (snapshot.empty) {
                    result += 'üìä No resources found in Firestore\n';
                    result += 'Returning sample data as fallback...\n\n';
                    
                    const sampleResources = [
                        {
                            id: 'sample-1',
                            name: 'Computer Lab A',
                            type: 'lab',
                            description: 'Fully equipped computer lab with 25 workstations',
                            category: 'Laboratory',
                            location: 'Building A, Room 101',
                            capacity: 25,
                            status: 'available',
                            isUnderMaintenance: false,
                            maintenanceNote: '',
                            features: ['Computers', 'Projector', 'Whiteboard'],
                            equipment: ['Computers', 'Projector', 'Whiteboard'],
                            maintenanceSchedule: 'Monthly',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: 'sample-2',
                            name: 'Conference Room B',
                            type: 'room',
                            description: 'Professional conference room with presentation equipment',
                            category: 'Meeting Room',
                            location: 'Building B, Room 205',
                            capacity: 15,
                            status: 'available',
                            isUnderMaintenance: false,
                            maintenanceNote: '',
                            features: ['Projector', 'Video Conference System', 'Whiteboard'],
                            equipment: ['Projector', 'Video Conference System', 'Whiteboard'],
                            maintenanceSchedule: 'Quarterly',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: 'sample-3',
                            name: 'Science Lab',
                            type: 'lab',
                            description: 'Advanced science laboratory with modern equipment',
                            category: 'Laboratory',
                            location: 'Building C, Room 301',
                            capacity: 20,
                            status: 'available',
                            isUnderMaintenance: false,
                            maintenanceNote: '',
                            features: ['Microscopes', 'Lab Equipment', 'Safety Gear'],
                            equipment: ['Microscopes', 'Lab Equipment', 'Safety Gear'],
                            maintenanceSchedule: 'Weekly',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }
                    ];
                    
                    result += `‚úÖ Sample resources loaded: ${sampleResources.length} resources\n\n`;
                    result += 'Sample Resources:\n';
                    sampleResources.forEach((resource, index) => {
                        result += `${index + 1}. ${resource.name} (${resource.type}) - ${resource.status}\n`;
                    });
                    
                    updateStatus('resources-status', 'Sample Data', 'warning');
                    showResult('resources-result', result, 'warning');
                } else {
                    const resources = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    result += `‚úÖ Successfully fetched ${resources.length} resources from Firestore\n\n`;
                    result += 'Resources:\n';
                    resources.forEach((resource, index) => {
                        result += `${index + 1}. ${resource.name} (${resource.type}) - ${resource.status}\n`;
                    });
                    
                    updateStatus('resources-status', 'Success', 'success');
                    showResult('resources-result', result, 'success');
                }
            } catch (error) {
                result += `‚ùå Error fetching resources: ${error.message}\n`;
                updateStatus('resources-status', 'Failed', 'error');
                showResult('resources-result', result, 'error');
            }
        };

        window.testGetAllBookings = async () => {
            showResult('bookings-result', 'Testing get all bookings...\n\n', 'info');
            
            let result = 'üìã All Bookings Test\n';
            result += '===================\n\n';
            
            try {
                const q = collection(db, 'bookings');
                const querySnapshot = await getDocs(q);
                const bookings = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                result += `‚úÖ Successfully fetched ${bookings.length} bookings\n\n`;
                
                if (bookings.length > 0) {
                    result += 'Bookings:\n';
                    bookings.forEach((booking, index) => {
                        result += `${index + 1}. ${booking.resourceName} - ${booking.userName} (${booking.status})\n`;
                    });
                } else {
                    result += 'No bookings found in database\n';
                }
                
                updateStatus('bookings-status', 'Success', 'success');
                showResult('bookings-result', result, 'success');
            } catch (error) {
                result += `‚ùå Error fetching bookings: ${error.message}\n`;
                updateStatus('bookings-status', 'Failed', 'error');
                showResult('bookings-result', result, 'error');
            }
        };

        window.testGetBookingsByUser = async () => {
            if (!currentUser) {
                showResult('bookings-result', '‚ùå Cannot test user bookings - no authenticated user\n', 'error');
                return;
            }
            
            showResult('bookings-result', 'Testing get bookings by user...\n\n', 'info');
            
            let result = 'üìã User Bookings Test\n';
            result += '====================\n\n';
            
            try {
                const q = query(collection(db, 'bookings'), where('userId', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                const bookings = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                result += `‚úÖ Successfully fetched ${bookings.length} bookings for user ${currentUser.email}\n\n`;
                
                if (bookings.length > 0) {
                    result += 'User Bookings:\n';
                    bookings.forEach((booking, index) => {
                        result += `${index + 1}. ${booking.resourceName} - ${booking.status}\n`;
                    });
                } else {
                    result += 'No bookings found for this user\n';
                }
                
                showResult('bookings-result', result, 'success');
            } catch (error) {
                result += `‚ùå Error fetching user bookings: ${error.message}\n`;
                showResult('bookings-result', result, 'error');
            }
        };

        window.testGetAllNotifications = async () => {
            showResult('notifications-result', 'Testing get all notifications...\n\n', 'info');
            
            let result = 'üîî All Notifications Test\n';
            result += '========================\n\n';
            
            try {
                const q = collection(db, 'notifications');
                const querySnapshot = await getDocs(q);
                const notifications = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                result += `‚úÖ Successfully fetched ${notifications.length} notifications\n\n`;
                
                if (notifications.length > 0) {
                    result += 'Notifications:\n';
                    notifications.forEach((notification, index) => {
                        result += `${index + 1}. ${notification.title} - ${notification.type}\n`;
                    });
                } else {
                    result += 'No notifications found in database\n';
                }
                
                updateStatus('notifications-status', 'Success', 'success');
                showResult('notifications-result', result, 'success');
            } catch (error) {
                result += `‚ùå Error fetching notifications: ${error.message}\n`;
                updateStatus('notifications-status', 'Failed', 'error');
                showResult('notifications-result', result, 'error');
            }
        };

        window.testGetNotificationsByUser = async () => {
            if (!currentUser) {
                showResult('notifications-result', '‚ùå Cannot test user notifications - no authenticated user\n', 'error');
                return;
            }
            
            showResult('notifications-result', 'Testing get notifications by user...\n\n', 'info');
            
            let result = 'üîî User Notifications Test\n';
            result += '=========================\n\n';
            
            try {
                const q = query(collection(db, 'notifications'), where('userId', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                const notifications = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                result += `‚úÖ Successfully fetched ${notifications.length} notifications for user ${currentUser.email}\n\n`;
                
                if (notifications.length > 0) {
                    result += 'User Notifications:\n';
                    notifications.forEach((notification, index) => {
                        result += `${index + 1}. ${notification.title} - ${notification.type}\n`;
                    });
                } else {
                    result += 'No notifications found for this user\n';
                }
                
                showResult('notifications-result', result, 'success');
            } catch (error) {
                result += `‚ùå Error fetching user notifications: ${error.message}\n`;
                showResult('notifications-result', result, 'error');
            }
        };

        window.testCompleteDashboard = async () => {
            showResult('dashboard-result', 'Testing complete dashboard loading...\n\n', 'info');
            
            let result = 'üéØ Complete Dashboard Test\n';
            result += '==========================\n\n';
            
            try {
                if (!currentUser) {
                    result += '‚ùå Cannot test dashboard - no authenticated user\n';
                    updateStatus('dashboard-status', 'Failed', 'error');
                    showResult('dashboard-result', result, 'error');
                    return;
                }
                
                result += `Testing dashboard for user: ${currentUser.email}\n`;
                result += `User ID: ${currentUser.uid}\n\n`;
                
                // Test all functions
                const results = {
                    users: 0,
                    resources: 0,
                    bookings: 0,
                    notifications: 0
                };
                
                // Test users
                try {
                    const usersRef = collection(db, 'users');
                    const usersSnapshot = await getDocs(usersRef);
                    results.users = usersSnapshot.docs.length;
                    result += `‚úÖ Users: ${results.users} found\n`;
                } catch (error) {
                    result += `‚ùå Users: Error - ${error.message}\n`;
                }
                
                // Test resources
                try {
                    const resourcesRef = collection(db, 'resources');
                    const resourcesSnapshot = await getDocs(resourcesRef);
                    if (resourcesSnapshot.empty) {
                        results.resources = 3; // Sample data
                        result += `‚úÖ Resources: 3 sample resources (no data in Firestore)\n`;
                    } else {
                        results.resources = resourcesSnapshot.docs.length;
                        result += `‚úÖ Resources: ${results.resources} found\n`;
                    }
                } catch (error) {
                    result += `‚ùå Resources: Error - ${error.message}\n`;
                }
                
                // Test bookings
                try {
                    const bookingsRef = collection(db, 'bookings');
                    const bookingsSnapshot = await getDocs(bookingsRef);
                    results.bookings = bookingsSnapshot.docs.length;
                    result += `‚úÖ Bookings: ${results.bookings} found\n`;
                } catch (error) {
                    result += `‚ùå Bookings: Error - ${error.message}\n`;
                }
                
                // Test notifications
                try {
                    const notificationsRef = collection(db, 'notifications');
                    const notificationsSnapshot = await getDocs(notificationsRef);
                    results.notifications = notificationsSnapshot.docs.length;
                    result += `‚úÖ Notifications: ${results.notifications} found\n`;
                } catch (error) {
                    result += `‚ùå Notifications: Error - ${error.message}\n`;
                }
                
                result += '\n';
                result += 'üìä Dashboard Summary:\n';
                result += `- Users: ${results.users}\n`;
                result += `- Resources: ${results.resources}\n`;
                result += `- Bookings: ${results.bookings}\n`;
                result += `- Notifications: ${results.notifications}\n\n`;
                
                if (results.users > 0 && results.resources > 0) {
                    result += '‚úÖ Dashboard should work properly!\n';
                    result += 'If you\'re still seeing errors, check the browser console for more details.\n';
                    updateStatus('dashboard-status', 'Success', 'success');
                    showResult('dashboard-result', result, 'success');
                } else {
                    result += '‚ö†Ô∏è Dashboard may have issues with data loading\n';
                    updateStatus('dashboard-status', 'Partial', 'warning');
                    showResult('dashboard-result', result, 'warning');
                }
                
            } catch (error) {
                result += `‚ùå Complete dashboard test failed: ${error.message}\n`;
                updateStatus('dashboard-status', 'Failed', 'error');
                showResult('dashboard-result', result, 'error');
            }
        };
    </script>
</body>
</html>
